---
import Layout from "../../layouts/Layout.astro";
import StoreGrid from "../../components/react/StoreGrid";
import { client as shopifyClient } from "../../lib/shopify";
import { GET_PRODUCTS_BY_COLLECTION } from "../../lib/queries/products";
import Breadcrumbs from "../../components/Breadcrumbs.astro";
import { gql } from 'graphql-request';

// SSG: Fetch all collections to generate paths
// SSG: Fetch all collections to generate paths
export async function getStaticPaths() {
  const GET_ALL_COLLECTIONS = gql`
    query getAllCollections {
      collections(first: 100) {
        edges {
          node {
            handle
          }
        }
      }
    }
  `;

  try {
    const response = await shopifyClient.request(GET_ALL_COLLECTIONS);
    const collections = response.data?.collections?.edges?.map((edge: any) => edge.node) || [];
    
    // Ensure critical collections are always present even if API misses them (e.g. newly created)
    const handles = new Set(collections.map((c: any) => c.handle));
    ['nuevo', 'best-sellers'].forEach(h => handles.add(h));

    return Array.from(handles).map((handle) => ({
      params: { handle },
    }));
  } catch (error) {
    console.error("Error fetching collections for SSG:", error);
    // Fallback headers
    return [
        { params: { handle: 'nuevo' } },
        { params: { handle: 'best-sellers' } }
    ];
  }
}

const { handle } = Astro.params;

let collection = null;
let products = [];
let error = false;

if (handle) {
  try {
    console.log(`[DEBUG] Fetching collection: ${handle}`);
    const response = await shopifyClient.request(GET_PRODUCTS_BY_COLLECTION, {
      variables: {
        handle: handle,
      },
    });
    
    collection = response.data?.collection;
    products = collection?.products?.edges?.map((edge: any) => edge.node) || [];
  } catch (err) {
    console.error(`Error fetching collection ${handle}:`, err);
    error = true;
  }
}

// Redirect if collection doesn't exist (optional, or show 404 content)
if (!collection && !error) {
   // Debugging info in console
   console.warn(`[DEBUG] Rendering 404 state for collection: ${handle}`);
}

const seo = {
  title: collection?.title
    ? `${collection.title} | DTalles Jewelry`
    : "Colección no encontrada",
  description:
    collection?.description ||
    `Explora nuestra exclusiva colección ${collection?.title || ""} en DTalles Jewelry. Oro 14k garantizado.`,
};
---

<Layout title={seo.title} description={seo.description}>
  <div class="max-w-[1920px] mx-auto pt-32 lg:pt-40 min-h-[60vh]">
    <div class="px-6 mb-2">
      <Breadcrumbs
        items={[
          { label: "Inicio", href: "/" },
          { label: "Colecciones", href: "/tienda" }, // Or just not link "Colecciones" if no index
          { label: collection?.title || handle || "Colección" },
        ]}
      />
    </div>

    {
      collection ? (
        <>
          <div class="px-6 pb-6 text-center">
            <h1 class="font-serif text-3xl md:text-5xl text-[#FAFAF5] mb-4">
              {collection.title}
            </h1>
            <div class="h-0.5 w-12 bg-[#d4af37] mx-auto mb-4" />
            {collection.description && (
              <div
                class="text-sm text-gray-400 font-light max-w-lg mx-auto leading-relaxed prose prose-invert prose-sm"
                set:html={collection.descriptionHtml || collection.description}
              />
            )}
            {!collection.description && (
              <p class="text-sm text-gray-400 font-light max-w-xs mx-auto leading-relaxed">
                Joyas exclusivas en Oro 14k.
              </p>
            )}
          </div>

          {products.length > 0 ? (
            <StoreGrid client:load initialProducts={products} />
          ) : (
            <div class="text-center py-20 px-4">
              <span class="material-symbols-outlined text-6xl text-gray-700 mb-4">
                manage_search
              </span>
              <p class="text-xl text-gray-500 font-light">
                No hay productos disponibles en esta colección por el momento.
              </p>
              <a
                href="/tienda"
                class="inline-block mt-6 px-8 py-3 border border-[#d4af37] text-[#d4af37] uppercase tracking-widest text-xs font-bold hover:bg-[#d4af37] hover:text-black transition-colors"
              >
                Ver Todo
              </a>
            </div>
          )}
        </>
      ) : (
        <div class="text-center py-32 px-4">
          <h1 class="text-3xl text-gray-500 mb-4">Colección no encontrada</h1>
          <p class="text-gray-400 mb-8">
            La colección "{handle}" no existe o no está disponible.
          </p>
          <a
            href="/tienda"
            class="text-[#d4af37] underline underline-offset-4 hover:text-white"
          >
            Volver a la tienda
          </a>
        </div>
      )
    }
  </div>
</Layout>
